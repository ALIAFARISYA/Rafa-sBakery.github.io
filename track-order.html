<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Order - Rafa's Bakery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo"><span>Rafa's Bakery</span></div>
            <h1 class="page-title">Track Your Order</h1>
            <p class="page-subtitle">Enter your order number to check the status of your delicious treats</p>
        </div>
        
        <!-- Tracking Container -->
        <div class="tracking-container">
            <!-- Order Lookup -->
            <div class="order-lookup">
                <h2 class="lookup-title"><i class="fas fa-search"></i> Find Your Order</h2>
                <div class="lookup-form">
                    <input type="text" class="lookup-input" id="orderLookup" 
                           placeholder="Enter your order number (e.g., DF-M834862)" 
                           value="DF-M834862">
                    <button class="lookup-btn" onclick="trackOrder()">
                        <i class="fas fa-search"></i> Track Order
                    </button>
                </div>
                <p style="margin-top: 15px; color: #a67c52; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> You can find your order number in your confirmation email
                </p>
            </div>
            
            <!-- Tracking Info (Hidden by Default) -->
            <div class="tracking-info" id="trackingInfo">
                <!-- Order Header -->
                <div class="order-header">
                    <div>
                        <div class="order-id-display" id="displayOrderId">DF-M834862</div>
                        <div class="order-date" id="orderDateDisplay">Order placed on 15 Dec 2023</div>
                    </div>
                    <div id="orderStatusBadge" class="status-badge">Preparing</div>
                </div>
                
                <!-- Status Overview -->
                <div class="status-overview">
                    <h3 class="status-title"><i class="fas fa-info-circle"></i> Current Status</h3>
                    <p class="status-message" id="statusMessage">
                        Your order is being prepared by our expert bakers. We're carefully crafting your delicious treats with the finest ingredients.
                    </p>
                </div>
                
                <!-- Estimated Time -->
                <div class="eta-container" id="etaContainer">
                    <h3 class="eta-title"><i class="fas fa-clock"></i> Estimated Ready Time</h3>
                    <div class="eta-time" id="etaTime">2:00 PM - 3:00 PM</div>
                    <p style="color: #5a3921;">Today, 16 December 2023</p>
                    <p style="font-size: 0.9rem; color: #a67c52; margin-top: 10px;">
                        <i class="fas fa-map-marker-alt"></i> 
                        <span id="pickupLocation">Self Pickup at Rafa's Bakery, Kuala Lumpur</span>
                    </p>
                </div>
                
                <!-- Timeline -->
                <div class="timeline-container">
                    <h3 class="timeline-title">Order Journey</h3>
                    <div class="timeline" id="orderTimeline">
                        <!-- Timeline items will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Order Details -->
                <div class="order-details">
                    <h3 class="status-title"><i class="fas fa-receipt"></i> Order Details</h3>
                    <div class="details-grid" id="orderDetailsGrid">
                        <!-- Order details will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="backToConfirmation()">
                        <i class="fas fa-receipt"></i> View Receipt
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='Contact.html'">
                        <i class="fas fa-headset"></i> Contact Support
                    </button>
                </div>
            </div>
            
            <!-- No Order Found -->
            <div class="no-order" id="noOrder">
                <div class="no-order-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3>Order Not Found</h3>
                <p>We couldn't find an order with that number. Please check your order number and try again, or contact our customer support for assistance.</p>
                <button class="btn btn-primary" onclick="showLookup()">
                    <i class="fas fa-search"></i> Try Another Order Number
                </button>
            </div>
        </div>
    </div>
    <script>
        // ==================== ORDER DATA ====================
const sampleOrders = {
    'DF-M834862': {
        orderId: 'DF-M834862',
        orderDateTime: '2023-12-15T14:30:00', // Bila order dibuat
        pickupDate: '2023-12-16', // Tarikh yang customer pilih
        pickupTime: '14:00-15:00', // Time slot yang customer pilih
        status: 'preparing',
        statusText: 'Preparing',
        customerName: 'Ahmad bin Ali',
        email: 'ahmad@example.com',
        phone: '012-3456789',
        deliveryMethod: 'self_pickup',
        deliveryAddress: 'Rafa\'s Bakery, Jalan Bukit Bintang, Kuala Lumpur',
        paymentMethod: 'FPX Online Banking (Maybank)',
        items: [
            { 
                name: 'Red Velvet Cake', 
                size: 'Medium', 
                price: 107.00,
                preparationTime: '24 hours',
                notes: 'Custom message: Happy Birthday!'
            },
            { 
                name: 'Chocolate Fudge Cake', 
                size: 'Small', 
                price: 87.00,
                preparationTime: '24 hours',
                notes: 'No nuts please'
            }
        ],
        subtotal: 194.00,
        deliveryFee: 0,
        discount: 12.00,
        total: 182.00,
        specialInstructions: 'Please add extra candles'
    },
    'DF-M123456': {
        orderId: 'DF-M123456',
        orderDateTime: '2023-12-14T10:15:00',
        pickupDate: '2023-12-16', // Order untuk 2 hari kemudian
        pickupTime: '15:00-16:00',
        status: 'scheduled',
        statusText: 'Scheduled',
        customerName: 'Sarah Tan',
        email: 'sarah.tan@example.com',
        phone: '013-9876543',
        deliveryMethod: 'delivery',
        deliveryAddress: 'No 15, Jalan SS2/24, Petaling Jaya, Selangor',
        paymentMethod: 'Credit Card',
        items: [
            { 
                name: 'Custom Wedding Cake', 
                size: '3-Tier Large', 
                price: 450.00,
                preparationTime: '48 hours',
                notes: 'White fondant with gold accents'
            }
        ],
        subtotal: 450.00,
        deliveryFee: 30.00,
        discount: 0,
        total: 480.00,
        specialInstructions: 'Deliver to wedding venue by 2 PM'
    },
    'DF-M789012': {
        orderId: 'DF-M789012',
        orderDateTime: '2023-12-16T09:45:00',
        pickupDate: '2023-12-17', // Untuk esok
        pickupTime: '11:00-12:00',
        status: 'scheduled',
        statusText: 'Scheduled',
        customerName: 'Raj Kumar',
        email: 'raj.kumar@example.com',
        phone: '011-2233445',
        deliveryMethod: 'self_pickup',
        deliveryAddress: 'Rafa\'s Bakery, Jalan Bukit Bintang, Kuala Lumpur',
        paymentMethod: 'eWallet',
        items: [
            { 
                name: 'Cheesecake', 
                size: 'Medium', 
                price: 95.00,
                preparationTime: '24 hours',
                notes: 'Extra strawberry topping'
            },
            { 
                name: 'Carrot Cake', 
                size: 'Small', 
                price: 75.00,
                preparationTime: '24 hours',
                notes: 'Cream cheese frosting'
            }
        ],
        subtotal: 170.00,
        deliveryFee: 0,
        discount: 17.00,
        total: 153.00,
        specialInstructions: 'Please write "Happy Anniversary"'
    }
};

// ==================== TIMELINE DATA ====================
const timelineStages = {
    'scheduled': [
        { 
            id: 'order_received', 
            status: 'Order Received', 
            description: 'We have received your order and payment confirmation',
            time: '10 mins after order',
            completed: true,
            active: false
        },
        { 
            id: 'scheduled', 
            status: 'Scheduled for Preparation', 
            description: 'Your order is scheduled for preparation before your pickup/delivery date',
            time: 'Based on your selected date',
            completed: false,
            active: true
        },
        { 
            id: 'preparing', 
            status: 'Preparation', 
            description: 'Our bakers will prepare your order',
            time: 'Before pickup/delivery',
            completed: false,
            active: false
        },
        { 
            id: 'ready', 
            status: 'Ready for Pickup/Delivery', 
            description: 'Your order will be ready during your selected time slot',
            time: 'Your selected time',
            completed: false,
            active: false
        }
    ],
    'preparing': [
        { 
            id: 'order_received', 
            status: 'Order Received', 
            description: 'We have received your order and payment confirmation',
            time: '10 mins after order',
            completed: true,
            active: false
        },
        { 
            id: 'preparation_started', 
            status: 'Preparation Started', 
            description: 'Our bakers have started preparing your order',
            time: 'Started on schedule',
            completed: true,
            active: false
        },
        { 
            id: 'currently_preparing', 
            status: 'Currently Preparing', 
            description: 'Our bakers are carefully crafting your items',
            time: 'In progress',
            completed: false,
            active: true
        },
        { 
            id: 'quality_check', 
            status: 'Quality Check', 
            description: 'Our team will ensure everything is perfect',
            time: 'Before dispatch',
            completed: false,
            active: false
        },
        { 
            id: 'ready', 
            status: 'Ready for Pickup/Delivery', 
            description: 'Your order will be ready during your selected time slot',
            time: 'Your selected time',
            completed: false,
            active: false
        }
    ],
    'ready': [
        { 
            id: 'order_received', 
            status: 'Order Received', 
            description: 'We have received your order and payment confirmation',
            time: '10 mins after order',
            completed: true,
            active: false
        },
        { 
            id: 'preparation_started', 
            status: 'Preparation Completed', 
            description: 'Our bakers have finished preparing your order',
            time: 'Completed',
            completed: true,
            active: false
        },
        { 
            id: 'quality_check', 
            status: 'Quality Check Passed', 
            description: 'Our team has verified the quality of your order',
            time: 'Completed',
            completed: true,
            active: false
        },
        { 
            id: 'ready', 
            status: 'Ready for Pickup/Delivery', 
            description: 'Your order is ready during your selected time slot',
            time: 'Your selected time - NOW',
            completed: false,
            active: true
        }
    ],
    'delivered': [
        { 
            id: 'order_received', 
            status: 'Order Received', 
            description: 'We have received your order and payment confirmation',
            time: '10 mins after order',
            completed: true,
            active: false
        },
        { 
            id: 'preparation_started', 
            status: 'Preparation Completed', 
            description: 'Our bakers prepared your delicious treats',
            time: 'Completed',
            completed: true,
            active: false
        },
        { 
            id: 'quality_check', 
            status: 'Quality Check Passed', 
            description: 'Our team verified the quality',
            time: 'Completed',
            completed: true,
            active: false
        },
        { 
            id: 'ready', 
            status: 'Ready for Pickup/Delivery', 
            description: 'Your order was ready during your selected time slot',
            time: 'As scheduled',
            completed: true,
            active: false
        },
        { 
            id: 'completed', 
            status: 'Order Completed', 
            description: 'Your order has been successfully picked up/delivered',
            time: 'Completed at selected time',
            completed: true,
            active: false
        }
    ]
};

// ==================== STATUS MESSAGES ====================
const statusMessages = {
    'scheduled': 'Your order is scheduled. We will start preparation closer to your pickup/delivery date to ensure freshness.',
    'preparing': 'Your order is being prepared by our expert bakers. We\'re carefully crafting your delicious treats with the finest ingredients.',
    'ready': 'Your order is ready! Please come to our bakery during your selected time slot.',
    'delivered': 'Your order has been successfully delivered/picked up. Thank you for choosing Rafa\'s Bakery!'
};

const statusColors = {
    'scheduled': '#3498db',
    'preparing': '#f39c12',
    'ready': '#27ae60',
    'delivered': '#8e44ad',
    'completed': '#8e44ad'
};

// ==================== TRACKING FUNCTIONS ====================
function trackOrder() {
    const orderId = document.getElementById('orderLookup').value.trim().toUpperCase();
    
    if (!orderId) {
        alert('Please enter an order number');
        return;
    }
    
    // Check if order exists
    const order = sampleOrders[orderId];
    const savedConfirmation = localStorage.getItem('orderConfirmation');
    let foundOrder = null;
    
    if (order) {
        foundOrder = order;
    } else if (savedConfirmation) {
        try {
            const savedOrder = JSON.parse(savedConfirmation);
            if (savedOrder.orderId === orderId) {
                foundOrder = convertSavedOrder(savedOrder);
            }
        } catch (error) {
            console.error('Error parsing saved confirmation:', error);
        }
    }
    
    if (foundOrder) {
        displayOrderTracking(foundOrder);
    } else {
        showNoOrder();
    }
}

function convertSavedOrder(savedOrder) {
    // Convert saved order data to tracking format
    const now = new Date();
    const pickupDate = savedOrder.deliveryDate ? new Date(savedOrder.deliveryDate) : new Date(now.getTime() + 24 * 60 * 60 * 1000); // Default esok
    
    // Determine status based on pickup date
    let status = 'scheduled';
    if (now.toDateString() === pickupDate.toDateString()) {
        status = 'preparing';
    }
    
    return {
        orderId: savedOrder.orderId || `DF-M${Math.floor(100000 + Math.random() * 900000)}`,
        orderDateTime: savedOrder.confirmationTime || new Date().toISOString(),
        pickupDate: pickupDate.toISOString().split('T')[0],
        pickupTime: savedOrder.deliveryTime || '14:00-15:00',
        status: status,
        statusText: status.charAt(0).toUpperCase() + status.slice(1),
        customerName: savedOrder.customerName || 'Customer',
        email: savedOrder.email || 'Not provided',
        phone: savedOrder.phone || 'Not provided',
        deliveryMethod: savedOrder.shippingMethod === 'delivery' ? 'delivery' : 'self_pickup',
        deliveryAddress: savedOrder.shippingAddress ? 
            `${savedOrder.shippingAddress.street}, ${savedOrder.shippingAddress.city}, ${savedOrder.shippingAddress.postcode} ${savedOrder.shippingAddress.state}, ${savedOrder.shippingAddress.country}` :
            'Rafa\'s Bakery, Kuala Lumpur',
        paymentMethod: savedOrder.paymentMethod || 'Unknown',
        items: savedOrder.cartItems || [],
        subtotal: savedOrder.subtotal ? parseFloat(savedOrder.subtotal.replace('RM', '').trim()) : 0,
        deliveryFee: savedOrder.deliveryFee ? parseFloat(savedOrder.deliveryFee.replace('RM', '').trim()) : 0,
        discount: savedOrder.discount && savedOrder.discount !== 'None' ? 
            parseFloat(savedOrder.discount.replace('-RM', '').trim()) : 0,
        total: savedOrder.total ? parseFloat(savedOrder.total.replace('RM', '').trim()) : 0,
        specialInstructions: savedOrder.specialInstructions || ''
    };
}

function displayOrderTracking(order) {
    // Update order header
    document.getElementById('displayOrderId').textContent = order.orderId;
    const orderDate = new Date(order.orderDateTime);
    const pickupDate = new Date(order.pickupDate);
    document.getElementById('orderDateDisplay').textContent = 
        `Order placed on ${formatDate(orderDate)} for ${formatDate(pickupDate)}`;
    
    // Update status badge
    const statusBadge = document.getElementById('orderStatusBadge');
    statusBadge.textContent = order.statusText;
    statusBadge.style.backgroundColor = statusColors[order.status] || '#3498db';
    
    // Update status message
    document.getElementById('statusMessage').textContent = statusMessages[order.status] || 'Your order is being processed.';
    
    // Update ETA section - THIS IS THE EXACT TIME CUSTOMER SELECTED
    const etaContainer = document.getElementById('etaContainer');
    const etaTime = document.getElementById('etaTime');
    
    etaTime.textContent = order.pickupTime;
    
    if (order.deliveryMethod === 'delivery') {
        etaContainer.innerHTML = `
            <h3 class="eta-title"><i class="fas fa-truck"></i> Scheduled Delivery Time</h3>
            <div class="eta-time">${order.pickupTime}</div>
            <p style="color: #5a3921;">${formatDate(pickupDate)}</p>
            <p style="font-size: 0.9rem; color: #a67c52; margin-top: 10px;">
                <i class="fas fa-map-marker-alt"></i> 
                <span>Delivering to: ${order.deliveryAddress}</span>
            </p>
            ${order.specialInstructions ? `
            <div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 8px; border-left: 3px solid #d4a574;">
                <i class="fas fa-sticky-note"></i> 
                <strong>Special Instructions:</strong> ${order.specialInstructions}
            </div>` : ''}
        `;
        etaContainer.style.backgroundColor = '#e8f5e9';
        etaContainer.style.borderLeftColor = '#27ae60';
    } else {
        etaContainer.innerHTML = `
            <h3 class="eta-title"><i class="fas fa-store"></i> Pickup Time Slot</h3>
            <div class="eta-time">${order.pickupTime}</div>
            <p style="color: #5a3921;">${formatDate(pickupDate)}</p>
            <p style="font-size: 0.9rem; color: #a67c52; margin-top: 10px;">
                <i class="fas fa-map-marker-alt"></i> 
                <span>Rafa's Bakery, Jalan Bukit Bintang, Kuala Lumpur</span>
            </p>
            ${order.specialInstructions ? `
            <div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 8px; border-left: 3px solid #d4a574;">
                <i class="fas fa-sticky-note"></i> 
                <strong>Special Instructions:</strong> ${order.specialInstructions}
            </div>` : ''}
        `;
        etaContainer.style.backgroundColor = '#fff8e1';
        etaContainer.style.borderLeftColor = '#f1c40f';
    }
    
    // Generate timeline
    const timeline = timelineStages[order.status] || timelineStages['scheduled'];
    generateTimeline(timeline);
    
    // Generate order details
    generateOrderDetails(order);
    
    // Show tracking info
    document.getElementById('trackingInfo').style.display = 'block';
    document.getElementById('noOrder').style.display = 'none';
    
    // Scroll to tracking info
    document.getElementById('trackingInfo').scrollIntoView({ behavior: 'smooth' });
}

function generateTimeline(timeline) {
    const timelineContainer = document.getElementById('orderTimeline');
    
    let timelineHTML = '';
    
    timeline.forEach((stage, index) => {
        let stageClass = '';
        if (stage.completed) {
            stageClass = 'completed';
        } else if (stage.active) {
            stageClass = 'active';
        }
        
        timelineHTML += `
            <div class="timeline-item ${stageClass}">
                <div class="timeline-content">
                    <div class="timeline-time">
                        <i class="fas fa-clock"></i> ${stage.time}
                    </div>
                    <div class="timeline-status">${stage.status}</div>
                    <div class="timeline-description">${stage.description}</div>
                </div>
            </div>
        `;
    });
    
    timelineContainer.innerHTML = timelineHTML;
}

function generateOrderDetails(order) {
    const detailsGrid = document.getElementById('orderDetailsGrid');
    
    let itemsHTML = '';
    order.items.forEach(item => {
        itemsHTML += `
            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e8d5b7;">
                <strong>${item.name}</strong> (${item.size})<br>
                <small>${item.notes || ''}</small>
            </div>
        `;
    });
    
    const detailsHTML = `
        <div class="detail-item">
            <div class="detail-label">Customer Name</div>
            <div class="detail-value">${order.customerName}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Contact Number</div>
            <div class="detail-value">${order.phone}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Email Address</div>
            <div class="detail-value">${order.email}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Delivery Method</div>
            <div class="detail-value">${order.deliveryMethod === 'delivery' ? 'Delivery' : 'Self Pickup'}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Payment Method</div>
            <div class="detail-value">${order.paymentMethod}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Order Items</div>
            <div class="detail-value">${itemsHTML}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Order Total</div>
            <div class="detail-value">RM ${order.total.toFixed(2)}</div>
        </div>
    `;
    
    detailsGrid.innerHTML = detailsHTML;
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-MY', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
    } catch (error) {
        return dateString;
    }
}

function showNoOrder() {
    document.getElementById('trackingInfo').style.display = 'none';
    document.getElementById('noOrder').style.display = 'block';
}

function showLookup() {
    document.getElementById('noOrder').style.display = 'none';
    document.getElementById('orderLookup').focus();
}

function backToConfirmation() {
    window.location.href = 'confirmation.html';
}

function contactSupport() {
    // Get order ID for passing to contact page
    const orderId = document.getElementById('displayOrderId')?.textContent || '';
    
    // Save order ID to localStorage for contact page
    if (orderId) {
        localStorage.setItem('contactOrderId', orderId);
    }
    
    // Redirect to contact page
    window.location.href = 'contact.html';
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    // Check if there's a saved order confirmation
    const savedConfirmation = localStorage.getItem('orderConfirmation');
    if (savedConfirmation) {
        try {
            const order = JSON.parse(savedConfirmation);
            if (order.orderId) {
                document.getElementById('orderLookup').value = order.orderId;
                // Auto-track the saved order
                setTimeout(() => {
                    trackOrder();
                }, 500);
            }
        } catch (error) {
            console.error('Error loading saved order:', error);
        }
    }
    
    // Allow Enter key to trigger tracking
    document.getElementById('orderLookup').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            trackOrder();
        }
    });
});

const accountLink = document.getElementById("accountLink");

if (localStorage.getItem("isLoggedIn")) {
    accountLink.href = "MyAccount.html";
}
    </script>
</body>
</html>